{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Plan Rejection Log Entry",
  "description": "Schema for an entry in the plan_rejection_log.json file.",
  "type": "array",
  "items": {
    "type": "object",
    "properties": {
      "log_entry_id": {
        "type": "string",
        "format": "uuid",
        "description": "Unique identifier for this log entry."
      },
      "loop_id": {
        "type": "string",
        "description": "Identifier for the operational loop."
      },
      "plan_id": {
        "type": "string",
        "description": "The ID of the rejected plan."
      },
      "comparison_set_id": { 
        "type": "string",
        "description": "The ID of the comparison set from which the plan was selected (from loop_plan_selection_log)."
      },
      "rejection_reason": {
        "type": "string",
        "description": "Textual description of why the plan was rejected."
      },
      "triggering_metric": {
        "type": "string",
        "description": "The specific metric(s) and value(s) that failed the threshold (e.g., 'emotion.negative_valence < -0.7')."
      },
      "threshold_details": {
        "type": "object",
        "description": "Details of the threshold that was breached.",
        "properties": {
          "metric_path": {"type": "string"},
          "threshold_value": {"type": ["number", "string", "boolean"]},
          "actual_value": {"type": ["number", "string", "boolean"]},
          "condition": {"type": "string", "enum": ["less_than", "greater_than", "equals", "not_equals", "is_false", "is_true", "contains"]} 
        }
      },
      "timestamp": {
        "type": "string",
        "format": "date-time",
        "description": "ISO 8601 timestamp of when the rejection occurred."
      },
      "governance_context": {
        "type": "object",
        "description": "State of relevant metrics at the time of rejection.",
        "properties": {
          "emotion": {
            "type": "object",
            "properties": {
              "valence": {"type": "number"},
              "arousal": {"type": "number"}
            }
          },
          "trust": {
            "type": "object",
            "properties": {
              "score": {"type": "number"}
            }
          },
          "invariants": {
            "type": "object",
            "properties": {
              "status": {"type": "string"},
              "violated_critical_invariants": {"type": "array", "items": {"type": "string"}},
              "violated_non_critical_invariants": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "required": ["emotion", "trust", "invariants"]
      }
    },
    "required": [
      "log_entry_id",
      "loop_id",
      "plan_id",
      "comparison_set_id",
      "rejection_reason",
      "triggering_metric",
      "timestamp",
      "governance_context"
    ]
  }
}

